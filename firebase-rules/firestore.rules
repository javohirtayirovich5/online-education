rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get user data from Firestore
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }
    
    // Check if user is teacher
    function isTeacher() {
      return isAuthenticated() && getUserData().role == 'teacher';
    }
    
    // Check if user is student
    function isStudent() {
      return isAuthenticated() && getUserData().role == 'student';
    }
    
    // Check if user is teacher or admin
    function isTeacherOrAdmin() {
      return isAdmin() || isTeacher();
    }
    
    // Check if user is approved
    function isApproved() {
      return getUserData().isApproved == true;
    }
    
    // Check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is course instructor
    function isCourseInstructor(courseId) {
      let course = get(/databases/$(database)/documents/courses/$(courseId)).data;
      return isAuthenticated() && course.instructorId == request.auth.uid;
    }
    
    // Check if user is enrolled in course
    function isEnrolledInCourse(courseId) {
      let course = get(/databases/$(database)/documents/courses/$(courseId)).data;
      return isAuthenticated() && request.auth.uid in course.enrolledStudents;
    }
    
    // Validate required fields
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if isAuthenticated();
      
      // User can create their own profile during registration
      allow create: if isOwner(userId) && 
                       hasRequiredFields(['email', 'displayName', 'role', 'createdAt']);
      
      // User can update their own profile (except role)
      allow update: if isOwner(userId) && 
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'isApproved']);
      
      // Admin can update any user (including role and approval status)
      allow update: if isAdmin();
      
      // Only admin can delete users
      allow delete: if isAdmin();
    }
    
    // ============================================
    // LESSONS COLLECTION (Video darslar)
    // ============================================
    match /lessons/{lessonId} {
      // Anyone authenticated can read lessons
      allow read: if isAuthenticated();
      
      // Only teachers and admins can create lessons
      allow create: if isTeacherOrAdmin() && 
                       hasRequiredFields(['title', 'description', 'teacherId', 'createdAt']);
      
      // Lesson owner or admin can fully update
      // Any authenticated user can update viewsCount and commentsCount only
      allow update: if isAdmin() || 
                       (isAuthenticated() && resource.data.teacherId == request.auth.uid) ||
                       (isAuthenticated() && 
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewsCount', 'commentsCount']));
      
      // Only admin or lesson owner can delete
      allow delete: if isAdmin() || 
                       (isAuthenticated() && resource.data.teacherId == request.auth.uid);
      
      // Comments subcollection
      match /comments/{commentId} {
        // Anyone authenticated can read comments
        allow read: if isAuthenticated();
        
        // Anyone authenticated can create comments
        allow create: if isAuthenticated();
        
        // Author can update their own comment
        allow update: if isAuthenticated() && resource.data.authorId == request.auth.uid;
        
        // Author, lesson owner, or admin can delete
        allow delete: if isAdmin() || 
                         isOwner(resource.data.authorId) ||
                         (isAuthenticated() && get(/databases/$(database)/documents/lessons/$(lessonId)).data.teacherId == request.auth.uid);
      }
    }
    
    // ============================================
    // COURSES COLLECTION
    // ============================================
    match /courses/{courseId} {
      // Anyone authenticated can read courses
      allow read: if isAuthenticated();
      
      // Teachers and admins can create courses
      allow create: if isTeacherOrAdmin() && 
                       isApproved() &&
                       hasRequiredFields(['title', 'instructorId', 'createdAt']);
      
      // Course instructor or admin can fully update
      // Any authenticated user can update views, viewsCount and commentsCount only
      allow update: if isAdmin() || 
                       (isAuthenticated() && resource.data.instructorId == request.auth.uid) ||
                       (isAuthenticated() && 
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views', 'viewsCount', 'commentsCount']));
      
      // Course instructor or admin can delete
      allow delete: if isAdmin() || 
                       (isAuthenticated() && resource.data.instructorId == request.auth.uid);
      
      // Comments subcollection
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated() && resource.data.authorId == request.auth.uid;
        allow delete: if isAdmin() || 
                         isOwner(resource.data.authorId) ||
                         (isAuthenticated() && get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId == request.auth.uid);
      }
    }
    
    // ============================================
    // ASSIGNMENTS COLLECTION
    // ============================================
    match /assignments/{assignmentId} {
      // Enrolled students, course instructor, and admin can read
      allow read: if isAuthenticated();
      
      // Only teachers and admins can create assignments
      allow create: if isTeacherOrAdmin() && 
                       isApproved() &&
                       hasRequiredFields(['title', 'description', 'createdBy', 'createdAt']);
      
      // Only creator or admin can update
      allow update: if isAdmin() || 
                       (isAuthenticated() && resource.data.createdBy == request.auth.uid);
      
      // Only admin or creator can delete
      allow delete: if isAdmin() || 
                       (isAuthenticated() && resource.data.createdBy == request.auth.uid);
    }
    
    // ============================================
    // SUBMISSIONS COLLECTION
    // ============================================
    match /submissions/{submissionId} {
      // Student can read their own submissions
      // Teacher can read submissions for their assignments
      // Admin can read all
      allow read: if isAdmin() || 
                     isOwner(resource.data.studentId) ||
                     (isTeacher() && isApproved());
      
      // Students can create submissions
      allow create: if isStudent() && 
                       isOwner(request.resource.data.studentId) &&
                       hasRequiredFields(['assignmentId', 'studentId', 'submittedAt']);
      
      // Students can update their own ungraded submissions
      allow update: if isOwner(resource.data.studentId) && 
                       resource.data.grade == null;
      
      // Teachers and admins can update (grade) submissions
      allow update: if isTeacherOrAdmin() && isApproved();
      
      // Only admin can delete submissions
      allow delete: if isAdmin();
    }
    
    // ============================================
    // QUIZZES COLLECTION
    // ============================================
    match /quizzes/{quizId} {
      allow read: if isAuthenticated();
      
      allow create: if isTeacherOrAdmin() && 
                       isApproved() &&
                       hasRequiredFields(['title', 'courseId', 'createdAt']);
      
      allow update: if isAdmin() || 
                       (isAuthenticated() && resource.data.createdBy == request.auth.uid);
      
      allow delete: if isAdmin() || 
                       (isAuthenticated() && resource.data.createdBy == request.auth.uid);
      
      // Quiz attempts subcollection
      match /attempts/{attemptId} {
        allow read: if isAdmin() || isOwner(resource.data.studentId);
        allow create: if isStudent() && isOwner(request.resource.data.studentId);
        allow update: if isTeacherOrAdmin();
        allow delete: if isAdmin();
      }
    }
    
    // ============================================
    // GRADES COLLECTION
    // ============================================
    match /grades/{gradeId} {
      // Students can read their own grades
      // Teachers and admins can read all
      allow read: if isAdmin() || 
                     isTeacher() ||
                     isOwner(resource.data.studentId);
      
      // Only teachers and admins can create grades
      allow create: if isTeacherOrAdmin() && 
                       isApproved() &&
                       hasRequiredFields(['studentId', 'score', 'maxScore', 'gradedAt']);
      
      // Only teachers and admins can update
      allow update: if isTeacherOrAdmin() && isApproved();
      
      // Only admin can delete grades
      allow delete: if isAdmin();
    }
    
    // ============================================
    // ATTENDANCE COLLECTION
    // ============================================
    match /attendance/{attendanceId} {
      // Students can read their own attendance
      // Teachers and admins can read all
      allow read: if isAdmin() || 
                     isTeacher() ||
                     isOwner(resource.data.studentId);
      
      // Only teachers and admins can manage attendance
      allow create: if isTeacherOrAdmin() && 
                       isApproved() &&
                       hasRequiredFields(['courseId', 'studentId', 'date', 'status']);
      
      allow update: if isTeacherOrAdmin() && isApproved();
      
      allow delete: if isAdmin();
    }
    
    // ============================================
    // ANNOUNCEMENTS COLLECTION
    // ============================================
    match /announcements/{announcementId} {
      // Anyone authenticated can read announcements
      allow read: if isAuthenticated();
      
      // Only teachers and admins can create
      allow create: if isTeacherOrAdmin() && 
                       isApproved() &&
                       hasRequiredFields(['title', 'content', 'authorId', 'createdAt']);
      
      // Only author or admin can update
      allow update: if isAdmin() || 
                       (isAuthenticated() && resource.data.authorId == request.auth.uid);
      
      // Only admin or author can delete
      allow delete: if isAdmin() || 
                       (isAuthenticated() && resource.data.authorId == request.auth.uid);
    }
    
    // ============================================
    // FORUM POSTS COLLECTION
    // ============================================
    match /forums/{forumId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
                       hasRequiredFields(['title', 'content', 'authorId', 'createdAt']);
      
      // Author can update their own posts
      allow update: if isAdmin() || isOwner(resource.data.authorId);
      
      // Admin or author can delete
      allow delete: if isAdmin() || isOwner(resource.data.authorId);
      
      // Replies subcollection
      match /replies/{replyId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAdmin() || isOwner(resource.data.authorId);
        allow delete: if isAdmin() || isOwner(resource.data.authorId);
      }
    }
    
    // ============================================
    // MESSAGES COLLECTION
    // ============================================
    match /messages/{conversationId} {
      // Only participants can read conversations
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.participants;
      
      // Authenticated users can create conversations
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants;
      
      // Only participants can update
      allow update: if isAuthenticated() && 
                       request.auth.uid in resource.data.participants;
      
      // Only admin can delete conversations
      allow delete: if isAdmin();
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
                       request.auth.uid in get(/databases/$(database)/documents/messages/$(conversationId)).data.participants;
        allow create: if isAuthenticated() && 
                         request.auth.uid in get(/databases/$(database)/documents/messages/$(conversationId)).data.participants;
        allow update: if isOwner(resource.data.senderId);
        allow delete: if isAdmin() || isOwner(resource.data.senderId);
      }
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isOwner(resource.data.userId);
      
      // System can create (through Cloud Functions) or admin
      allow create: if isAdmin() || isTeacherOrAdmin();
      
      // User can update their own notifications (mark as read)
      allow update: if isOwner(resource.data.userId);
      
      // User can delete their own notifications
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // ============================================
    // RESOURCES COLLECTION
    // ============================================
    match /resources/{resourceId} {
      // Authenticated users can read resources for their group
      allow read: if isAuthenticated();
      
      // Teachers and admins can create resources
      allow create: if isTeacherOrAdmin() && 
                       isApproved() &&
                       hasRequiredFields(['groupId', 'subjectId', 'teacherId', 'title', 'createdAt']);
      
      // Only creator or admin can update
      allow update: if isAdmin() || 
                       (isTeacher() && isApproved() && resource.data.teacherId == request.auth.uid);
      
      // Only creator or admin can delete
      allow delete: if isAdmin() || 
                       (isTeacher() && isApproved() && resource.data.teacherId == request.auth.uid);
    }

    // ============================================
    // DELETED EMAILS COLLECTION
    // ============================================
    match /deletedEmails/{emailId} {
      // Only admins can read and write deleted emails
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // ============================================
    // SYSTEM SETTINGS (Admin only)
    // ============================================
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================
    // CATEGORIES COLLECTION
    // ============================================
    match /categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================
    // DEPARTMENTS COLLECTION
    // ============================================
    match /departments/{departmentId} {
      // Public read - ro'yxatdan o'tish uchun kerak
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ============================================
    // FACULTIES COLLECTION
    // ============================================
    match /faculties/{facultyId} {
      // Public read - ro'yxatdan o'tish uchun kerak
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ============================================
    // GROUPS COLLECTION
    // ============================================
    match /groups/{groupId} {
      // Public read - ro'yxatdan o'tish uchun kerak
      allow read: if true;
      
      // Admin can fully manage groups
      allow create, delete: if isAdmin();
      
      // Admin can update everything
      // Teachers can update their assigned groups (teacherIds array)
      // Students array can be updated when student registers (even during registration)
      // updatedAt ham qo'shilishi mumkin
      allow update: if isAdmin() || 
                       (isAuthenticated() && isTeacher() && request.auth.uid in resource.data.teacherIds) ||
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['students']) ||
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['students', 'updatedAt']);
    }
    
    // ============================================
    // SUBJECTS COLLECTION
    // ============================================
    match /subjects/{subjectId} {
      // Public read - ro'yxatdan o'tish uchun kerak
      allow read: if true;
      
      // Only admin can create and delete
      allow create, delete: if isAdmin();
      
      // Admin and assigned teacher can update
      allow update: if isAdmin() || 
                       (isTeacher() && resource.data.teacherId == request.auth.uid);
    }
    
    // ============================================
    // ATTENDANCE COLLECTION (Yangilangan)
    // ============================================
    match /attendance/{attendanceId} {
      // Students can read attendance for their group
      // Teachers can read attendance for their groups
      // Admin can read all
      allow read: if isAuthenticated();
      
      // Teachers and admins can create/update attendance
      allow create: if isTeacherOrAdmin();
      
      allow update: if isAdmin() || 
                       (isTeacher() && resource.data.teacherId == request.auth.uid);
      
      allow delete: if isAdmin();
    }
    
    // ============================================
    // GRADES COLLECTION (Yangilangan - 5 ballik)
    // ============================================
    match /grades/{gradeId} {
      // Students can read their own grades
      // Teachers can read grades they created
      // Admin can read all
      allow read: if isAuthenticated();
      
      // Teachers and admins can create grades
      allow create: if isTeacherOrAdmin();
      
      // Only grade creator or admin can update
      allow update: if isAdmin() || 
                       (isTeacher() && resource.data.teacherId == request.auth.uid);
      
      // Only admin or grade creator can delete
      allow delete: if isAdmin() || 
                       (isTeacher() && resource.data.teacherId == request.auth.uid);
    }

    // ============================================
    // TESTS COLLECTION
    // ============================================
    match /tests/{testId} {
      // All authenticated users can read tests
      allow read: if isAuthenticated();
      
      // Only teachers and admins can create tests
      allow create: if isTeacherOrAdmin() && 
                       hasRequiredFields(['title', 'questions', 'createdBy', 'createdAt']);
      
      // Only test creator or admin can update
      allow update: if isAdmin() || 
                       (isTeacher() && resource.data.createdBy == request.auth.uid);
      
      // Only test creator or admin can delete
      allow delete: if isAdmin() || 
                       (isAuthenticated() && resource.data.createdBy == request.auth.uid);
    }

    // ============================================
    // TEST ANSWERS COLLECTION (Talabalarning javoblari)
    // ============================================
    match /testAnswers/{answerId} {
      // Students can read their own answers
      // Teachers can read answers to their tests
      // Admin can read all
      allow read: if isAuthenticated() && 
                     ((isStudent() && resource.data.studentId == request.auth.uid) ||
                     (isTeacher() && 
                        get(/databases/$(database)/documents/tests/$(resource.data.testId)).data.createdBy == request.auth.uid) ||
                     isAdmin());
      
      // Only students can create answers (submit test)
      allow create: if isStudent() && 
                       request.resource.data.studentId == request.auth.uid &&
                       hasRequiredFields(['testId', 'studentId', 'answers', 'submittedAt']);
      
      // Teachers can update scores, only admin can update other fields
      allow update: if isAdmin() || 
                       (isTeacher() && 
                        get(/databases/$(database)/documents/tests/$(resource.data.testId)).data.createdBy == request.auth.uid &&
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['score', 'isGraded', 'gradedAt', 'feedback']));
      
      // Test creator can delete answers for their test, admin can delete all
      allow delete: if isAdmin() || 
                       (isTeacher() && 
                        get(/databases/$(database)/documents/tests/$(resource.data.testId)).data.createdBy == request.auth.uid);
    }
    
    // ============================================
    // LIVE SESSIONS COLLECTION
    // ============================================
    match /liveSessions/{sessionId} {
      // Any authenticated user can read active sessions (for discovery)
      allow read: if isAuthenticated();

      // Only teachers (or admin) can create live sessions for their groups
      allow create: if isTeacherOrAdmin() && isApproved() &&
                      request.resource.data.teacherId == request.auth.uid &&
                      hasRequiredFields(['groupId', 'teacherId', 'provider', 'room', 'isLive']);

      // Only the session owner (teacher) or admin can update (end) the session
      allow update: if isAdmin() || (isAuthenticated() && resource.data.teacherId == request.auth.uid);

      // Only admin can delete sessions
      allow delete: if isAdmin();
    }
    
    // ============================================
    // LIBRARY COLLECTION (Favorites, Reading List)
    // ============================================
    match /library/{documentId} {
      // Users can read their own library data (including queries)
      allow read: if isAuthenticated() && 
                     (resource == null || resource.data.userId == request.auth.uid);
      
      // Users can create their own library entries
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'bookId', 'type']);
      
      // Users can update their own library entries
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == request.auth.uid;
      
      // Users can delete their own library entries
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
  }
}

